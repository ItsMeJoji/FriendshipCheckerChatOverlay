<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>{{ title or "App" }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="container">
        <canvas id="canvas" style="display: none;"></canvas>
        <!-- <div class="overlay"></div> -->
    </div>    

    <!-- In the body, add a chat display area -->
    <div id="chat-display">
    <div id="chat-messages"></div>
    </div>

    <!-- In CSS/style tag, position it on screen -->
    <style>
    #chat-display {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        height: 400px;
        background: rgba(0,0,0,0.8);
        border: 2px solid white;
        border-radius: 5px;
        overflow-y: auto;
    }
    .chat-message {
        color: white;
        padding: 8px;
        border-bottom: 1px solid #333;
        font-size: 12px;
    }
    .chat-username {
        font-weight: bold;
        color: #0e9;
    }
    </style>

<!-- In JavaScript, poll and display -->
    <script>
    const chatContainer = document.getElementById('chat-messages');
    const displayedMessages = new Set(); // Track which messages we've already displayed

    async function updateChatDisplay() {
        const response = await fetch('/api/active_chatters');
        const data = await response.json();
        
        // Loop through all chatters and their messages
        for (const [username, record] of Object.entries(data)) {
        for (const msg of record.messages) {
            const msgId = `${username}-${msg.timestamp}`;
            if (!displayedMessages.has(msgId)) {
            displayedMessages.add(msgId);
            
            // Create and append the message element
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message';
            msgEl.innerHTML = `<span class="chat-username">${username}:</span> ${msg.content}`;
            chatContainer.appendChild(msgEl);
            
            // Auto-scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        }
    }

    // Poll every 1 second
    setInterval(updateChatDisplay, 1000);
    updateChatDisplay(); // Initial call
    </script>
</body>
</html>